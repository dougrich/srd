/*
Copyright (c) 2016 Douglas Richardson
*/
function fetchRemote(e,t){var n=new XMLHttpRequest;n.onload=function(){200!==this.status?t(this.status,this.responseText):t(null,this.responseText)},n.onerror=function(){t(RESOURCES.errCouldntFetchFile)},n.open("GET",e),n.send()}function fetchLocal(e,t){var n=db.transaction([CONST.tbname],"readwrite").objectStore(CONST.tbname).get(e);n.onsuccess=function(e){e.target.result?t(null,e.target.result.body):t(CONST.cacheMiss,null)}}function storeLocal(e,t,n){e||db.transaction([CONST.tbname],"readwrite").objectStore(CONST.tbname).add({name:t.file,body:n})}function replyFactory(e){return function(t,n){postMessage({id:e.id,err:t,result:n})}}function queueProcessor(){for(;queue.length;)!function(e){var t=replyFactory(e);null===db?fetchRemote(e.file,t):fetchLocal(e.file,function(n,r){n===CONST.cacheMiss?fetchRemote(e.file,function(n,r){t(n,r),storeLocal(n,e,r)}):t(n,r)})}(queue.pop())}var CONST={version:2,dbname:"__offline-loader-db",tbname:"_resources",cacheMiss:"Missed Cache",processorInterval:100},RESOURCES={errDbNotCreatedSuccessfully:"IndexedDB not created successfully",errCouldntFetchFile:"Unable to fetch the file"},request=indexedDB.open(CONST.dbname,CONST.version),db=null,queue=[];request.onupgradeneeded=function(e){var t=e.target.result,n=t.createObjectStore(CONST.tbname,{keyPath:"name"});n.createIndex("name","name",{unique:!0}),n.transaction.oncomplete=function(e){db=t,setInterval(queueProcessor,CONST.processorInterval)}},request.onsuccess=function(e){db=e.target.result,setInterval(queueProcessor,CONST.processorInterval)},request.onerror=function(e){db=null,setInterval(queueProcessor,CONST.processorInterval),console.error(RESOURCES.errDbNotCreatedSuccessfully)},onmessage=function(e){queue.push(e.data)};